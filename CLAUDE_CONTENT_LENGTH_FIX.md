# Claude 內容長度問題修正

## 問題診斷

您觀察到 Claude 生成的內容被截斷，原因是：

### 根本原因

在 `backend/app/services/claude_service.py` 中，`max_tokens` 設定為 **4096**：

- 4096 tokens ≈ 3000-4000 中文字
- 這會限制 Claude 的輸出長度

### 修正方式

#### 1. 增加 max_tokens

```python
# 修改前
"max_tokens": max_tokens if max_tokens else 4096,

# 修改後
"max_tokens": max_tokens if max_tokens else 8192,  # 增加到 8192 tokens
```

#### 2. 更新系統提示

```python
# 修改前
"system": "你是一位資深的教學設計專家，專精於課程計劃的撰寫。",

# 修改後
"system": "你是一位資深的教學設計專家，專精於課程計劃的撰寫。請生成完整且詳細的內容。",
```

## 內容長度對照表

| max_tokens | 約等於中文字數 | 適用場景             |
| ---------- | -------------- | -------------------- |
| 2048       | ~1500-2000     | 簡短文檔             |
| 4096       | ~3000-4000     | 一般文檔（原本）     |
| 8192       | ~6000-8000     | 詳細文檔（修正後）✨ |

## 診斷工具

### 後端日誌

現在會在後端輸出：

```
📊 Claude 生成的內容長度: XXXX 字元
📝 內容預覽（前500字元）: ...
📝 內容結尾（後500字元）: ...
```

### 前端日誌

在瀏覽器控制台會顯示：

```
📊 教學理念內容長度: XXXX 字元
📊 學習目標內容長度: XXXX 字元
📊 教學策略內容長度: XXXX 字元
📊 教學流程內容長度: XXXX 字元
```

## 其他改進

### 1. CSS 改進

確保長內容能正確換行顯示：

```css
.generated-content {
  word-wrap: break-word;
  overflow-wrap: break-word;
  max-width: 100%;
}
```

### 2. 日誌追蹤

- ✅ 後端記錄生成內容長度
- ✅ 前端顯示接收內容長度
- ✅ 前後比對確認沒有截斷

## 驗證方法

### 1. 檢查後端日誌

```bash
tail -f /tmp/backend.log | grep "Claude 生成的內容長度"
```

### 2. 檢查瀏覽器控制台

打開瀏覽器的開發者工具 (F12)，查看 Console 標籤，會看到內容長度的日誌。

### 3. 實際測試

重新生成一次教學流程，觀察：

- 內容是否完整
- 後端日誌顯示的字元數
- 前端控制台顯示的字元數

## 預期效果

修正後，Claude 應該能夠生成：

- ✅ 完整的教學理念（6000+ 字元）
- ✅ 詳細的教學策略（5000+ 字元）
- ✅ 完整的教學流程（7000+ 字元）

## 如果還是有截斷

### 檢查點

1. **後端日誌**：檢查實際生成的字元數
2. **前端控制台**：檢查接收到的字元數
3. **比對**：兩者應該一致

### 進一步調整

如果 8192 還不夠，可以考慮：

- 增加到 16384 tokens
- 或使用 `max_tokens: None`（讓 Claude 自己決定，但仍可能有限制）

## 總結

✅ **已修正**：

- max_tokens: 4096 → 8192
- 添加內容長度日誌
- 改進顯示 CSS
- 添加系統提示

✅ **現在應該**：

- Claude 能生成完整內容
- 不會被截斷
- 可以記錄和追蹤長度

請重新生成一次教學流程，檢查內容是否完整！
