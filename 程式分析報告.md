# 程式分析報告

## 專案概述

這是一個 AI 驅動的課程計劃生成器，使用 FastAPI 作為後端，Vanilla JavaScript 作為前端。系統支持多種 AI 模型（OpenAI 和 Claude），能夠生成完整的課程計劃包括教學理念、學習目標、教學策略、教學流程，並透過 Gamma API 生成 PPT，最後生成學習單。

## 架構分析

### 後端架構

- **框架**: FastAPI
- **資料庫**: SQLite (開發) / PostgreSQL (生產)
- **ORM**: SQLAlchemy
- **主要服務**:
  - `OpenAIService`: OpenAI API 整合
  - `ClaudeService`: Anthropic Claude API 整合
  - `GammaService`: Gamma API 整合（PPT 生成）
  - `EncryptionService`: API Key 加密儲存

### 前端架構

- **技術**: Vanilla JavaScript, HTML5, CSS3
- **特性**:
  - 七步驟工作流程（Wizard）
  - 雙語支持（中文/英文）
  - 動態 AI 模型選擇
  - Prompt 編輯器
  - 歷史記錄管理

## 發現的問題

### 🔴 嚴重問題

#### 1. **API Key 洩露風險**

**位置**: `backend/app/api/routes.py:636, 717, 755`

```python
gamma_api_key = settings.gamma_api_key or os.getenv("GAMMA_API_KEY") or "sk-gamma-GlUo8DS1fqjaDlakxQuk3NFIkwgKTRYdkAOZTTb0A8"
```

**問題**: 硬編碼的 Gamma API Key 直接寫在程式碼中，這是一個嚴重的安全問題。

**建議**:

- 立即移除硬編碼的 API Key
- 從環境變數或加密的資料庫中讀取
- 如果已洩露，應立即在 Gamma 平台撤銷並重新生成

#### 2. **重複的生成學習單端點**

**位置**: `backend/app/api/routes.py:485-535` 和 `784-822`

**問題**: 有兩個完全重複的 `/courses/generate-worksheet` 端點，這會導致路由衝突。

**影響**: 第二個端點（784-822 行）永遠不會被調用，因為 FastAPI 會優先使用第一個定義的端點。

**建議**:

- 刪除重複的端點（784-822 行）
- 保留第一個實作（485-535 行），因為它有更完整的錯誤處理

#### 3. **ClaudeService 內容提取邏輯有潛在問題**

**位置**: `backend/app/services/claude_service.py:62-89`

```python
text_content = ""
for block in response.content:
    print(f"🔍 處理內容區塊: {type(block)}")
    # 檢查 block 的屬性
    if hasattr(block, 'text'):
        text_content += block.text
    elif hasattr(block, 'content') and hasattr(block.content[0], 'text'):
        # 處理嵌套結構
        text_content += block.content[0].text
    else:
        print(f"⚠️ 無法提取文本，block 屬性: {dir(block)}")
```

**問題**:

- 嵌套結構的檢查邏輯不完整（沒有檢查 `block.content` 是否存在或為空）
- 除錯資訊過多，影響效能
- 錯誤處理不充分

**建議**:

```python
text_content = ""
for block in response.content:
    if hasattr(block, 'text'):
        text_content += block.text
    elif hasattr(block, 'content'):
        for content_block in block.content:
            if hasattr(content_block, 'text'):
                text_content += content_block.text

if not text_content:
    raise Exception("Claude API 未返回任何文字內容")
```

### 🟡 中級問題

#### 4. **檔案上傳未清理舊檔案**

**位置**: `backend/app/api/routes.py:540-580`

**問題**: 每次上傳檔案都會創建新檔案，但從不清理舊檔案，會導致磁碟空間累積。

**建議**:

- 實作定期清理機制
- 或在上傳時刪除使用者的舊檔案
- 或限制檔案總數

#### 5. **缺少 API Key 驗證機制**

**位置**: `backend/app/api/routes.py:85-132`

**問題**: `set_api_key` 端點僅驗證 OpenAI API Key 的格式，但不驗證 Claude 或 Gamma API Key。

**建議**:

- 為 Claude 添加基本驗證（格式檢查）
- 為 Gamma 添加格式驗證
- 或在設定後立即測試 API Key 是否有效

#### 6. **前端沒有錯誤恢復機制**

**位置**: `frontend/app.js`

**問題**: 當 API 調用失敗時，前端只顯示 alert，但狀態可能不一致。

**建議**:

- 實作統一的錯誤處理函數
- 在錯誤時重置狀態
- 提供重試機制

#### 7. **Markdown 未使用最新語法**

**位置**: `frontend/index.html:587`

```html
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
```

**問題**: 使用舊版的 Marked.js，可能缺少安全更新和新功能。

**建議**: 指定版本號或使用最新穩定版。

#### 8. **語言切換不完整**

**位置**: `frontend/app.js:2139-2168`

**問題**: `saveCoursePlan` 函數使用 `localStorage.getItem("currentLanguage")`，但在其他地方使用的是 `localStorage.getItem("language")`，不一致。

**建議**: 統一使用相同的 localStorage key。

### 🟢 輕微問題 / 改進建議

#### 9. **缺少 API 速率限制**

**問題**: 沒有實作速率限制，可能被濫用。

**建議**: 使用 FastAPI 的限流中間件。

#### 10. **資料庫查詢缺少分頁**

**位置**: `backend/app/api/routes.py:867-895`

**問題**: `list_course_plans` 有分頁參數，但預設只查詢 20 筆，沒有總數資訊。

**建議**: 返回總數以便前端實作完整的分頁功能。

#### 11. **缺少資料驗證**

**位置**: `backend/app/api/routes.py:244-323`

**問題**: `generate_rationale` 接收的 `basic_info` 沒有使用 Pydantic 模型驗證。

**建議**: 創建 Pydantic 模型來驗證所有輸入。

#### 12. **前端硬編碼的 API URL**

**位置**: `frontend/app.js:5`

```javascript
const API_BASE_URL = "http://localhost:8000";
```

**問題**: 硬編碼的本地 URL，生產環境需手動修改。

**建議**: 使用環境變數或根據當前域名自動判斷。

#### 13. **Prompt 內容過長**

**位置**: `backend/app/prompts/__init__.py:6`

**問題**: 學習單生成的 Prompt 非常長（425 行），可能超出模型的 token 限制。

**建議**:

- 分段處理
- 使用更簡潔的 Prompt
- 考慮使用精簡模式

#### 14. **缺少 CSRF 保護**

**問題**: FastAPI 預設沒有 CSRF 保護。

**建議**: 在使用者的情況下實作 CSRF 保護。

#### 15. **錯誤訊息混合中英文**

**位置**: 整個專案

**問題**: 有些錯誤訊息是中文，有些是英文，不一致。

**建議**: 根據使用者選擇的語言提供對應的錯誤訊息。

## 程式碼品質

### 優點

1. ✅ 清晰的模組化架構
2. ✅ 良好的註解和文檔
3. ✅ 使用 Type Hints
4. ✅ 適當的錯誤處理
5. ✅ 詳細的日誌輸出

### 需要改進

1. ⚠️ 缺少單元測試
2. ⚠️ 缺少整合測試
3. ⚠️ API 文檔可能需要更詳細
4. ⚠️ 某些函數過長（如 `convertWorksheetToHTML`）
5. ⚠️ 前端程式碼可以進一步模組化

## 安全建議

1. **立即修復**:

   - 移除硬編碼的 Gamma API Key
   - 實作 API Key 加密儲存驗證

2. **短期改進**:

   - 添加速率限制
   - 實作使用者認證
   - 添加 HTTPS 強制
   - 檔案上傳驗證加強

3. **長期改進**:
   - 實作 OAuth 2.0
   - 添加審計日誌
   - 實作備份和恢復機制

## 效能建議

1. 添加快取機制（Redis）
2. 使用 CDN 提供靜態資源
3. 實作資料庫連接池
4. 前端程式碼壓縮和打包
5. 圖片和檔案壓縮

## 測試建議

目前專案缺少測試，建議添加：

1. 單元測試（Pytest）
2. API 整合測試
3. 前端 E2E 測試（Playwright/Cypress）
4. 效能測試

## 部署建議

1. 使用環境變數管理配置
2. 使用容器化部署（Docker）
3. 實作 CI/CD 流程
4. 添加健康檢查端點
5. 實作日誌收集和分析

## 總結

這是一個功能完整且架構清晰的專案，但在安全性、測試和某些實作細節上需要改進。最緊急的是修復 API Key 洩露問題和路由衝突問題。

### 優先修復順序

1. 🔴 移除硬編碼的 API Key
2. 🔴 修復重複的端點
3. 🟡 改進 Claude API 內容提取邏輯
4. 🟡 實作檔案清理機制
5. 🟢 統一語言切換邏輯

